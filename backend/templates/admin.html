<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ilse.Admin - Mimi.Today</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
  <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
  <script>
    // Set theme before page renders to prevent flash
    document.documentElement.setAttribute('data-theme', localStorage.getItem('admin-theme') || 'solid');
  </script>
  <style>
    /* Admin-specific styles */
    .admin-container {
      max-width: 100%;
      padding: 16px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .admin-header {
      text-align: center;
      padding: 8px 0 16px;
      flex-shrink: 0;
      position: relative;
    }

    .admin-header h1 {
      font-size: 1.8rem;
      color: var(--text-primary);
    }

    /* Theme Picker */
    .theme-picker {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 6px;
      background: var(--bg-card);
      padding: 6px 10px;
      border-radius: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .theme-option {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .theme-option:hover {
      transform: scale(1.15);
      z-index: 1;
    }

    .theme-option.active {
      border-color: var(--accent);
      box-shadow: 0 0 12px var(--accent);
      transform: scale(1.1);
    }

    /* Dark theme - moonlit purple */
    .theme-option[data-theme="dark"] {
      background: linear-gradient(135deg, #1a1b26, #24283b);
      box-shadow: inset 0 0 8px rgba(122, 162, 247, 0.3);
    }

    /* Solid theme - traffic lights */
    .theme-option[data-theme="solid"] {
      background: conic-gradient(from 0deg, #dc3545, #ffc107, #28a745, #dc3545);
    }

    /* Sunset theme - warm coral gradient */
    .theme-option[data-theme="sunset"] {
      background: linear-gradient(135deg, #f4a261, #e76f51, #e63946);
    }

    /* Ocean theme - deep sea */
    .theme-option[data-theme="ocean"] {
      background: linear-gradient(135deg, #0a192f, #1d3557, #64ffda);
    }

    /* Neon theme - cyberpunk */
    .theme-option[data-theme="neon"] {
      background: linear-gradient(135deg, #ff2a6d, #0d0221, #00d4ff);
      animation: neon-pulse 2s ease-in-out infinite alternate;
    }
    @keyframes neon-pulse {
      from { box-shadow: 0 0 5px #ff2a6d, inset 0 0 5px rgba(0, 212, 255, 0.3); }
      to { box-shadow: 0 0 10px #00d4ff, inset 0 0 8px rgba(255, 42, 109, 0.5); }
    }
    .theme-option[data-theme="neon"].active {
      animation: none;
      box-shadow: 0 0 15px #00d4ff, 0 0 30px #ff2a6d;
    }

    /* Paper theme - clean white */
    .theme-option[data-theme="paper"] {
      background: linear-gradient(135deg, #ffffff, #f8f9fa);
      border: 1px solid #dee2e6;
    }

    /* Day slider */
    .day-slider {
      display: flex;
      gap: 8px;
      padding: 8px 0 16px;
      justify-content: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .day-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .day-dot:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .day-dot.active {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    .day-dot.today {
      border-color: var(--color-completed);
    }

    /* Day panels container */
    .day-panels-wrapper {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .day-panels {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      padding: 0 16px;
      height: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .day-panels::-webkit-scrollbar {
      height: 6px;
    }
    
    .day-panels::-webkit-scrollbar-track {
      background: var(--bg-card);
      border-radius: 3px;
    }
    
    .day-panels::-webkit-scrollbar-thumb {
      background: var(--text-muted);
      border-radius: 3px;
    }

    /* Day panel */
    .day-panel {
      flex: 0 0 360px;
      scroll-snap-align: center;
      background: var(--bg-card);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 180px);
    }

    .day-panel-header {
      padding: 16px;
      border-bottom: 1px solid var(--bg-primary);
      text-align: center;
      flex-shrink: 0;
    }

    .day-panel-header h2 {
      font-size: 1.1rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .day-panel-header .date-str {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .day-panel-header .total-time {
      font-size: 0.8rem;
      color: var(--accent);
      margin-top: 4px;
    }

    .day-panel-tasks {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    /* Task card in admin */
    .admin-task-card {
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      position: relative;
      border-left: 3px solid var(--text-muted);
      transition: all 0.2s ease;
    }

    .admin-task-card.recurring {
      border-left-color: var(--accent);
    }

    .admin-task-card.one-time {
      border-left-color: var(--color-one-time, #9370db);
    }

    .admin-task-card:hover {
      background: var(--bg-hover);
    }

    .admin-task-card[draggable="true"] {
      cursor: grab;
      touch-action: none;
      user-select: none;
      -webkit-user-select: none;
    }

    .admin-task-card.dragging {
      opacity: 0.4;
      cursor: grabbing;
    }

    .admin-task-card.drag-over {
      border-top: 2px solid var(--accent);
      margin-top: -2px;
    }

    .day-panel-tasks.drag-over-panel {
      background: rgba(122, 162, 247, 0.1);
      border-radius: var(--radius-sm);
    }

    .admin-task-content {
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admin-task-title {
      flex: 1;
      font-weight: 500;
    }

    .repeat-badge {
      font-size: 0.85rem;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      background: var(--accent);
      color: var(--bg-primary);
      font-weight: 600;
      white-space: nowrap;
    }

    .admin-task-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .admin-task-card:hover .admin-task-actions {
      opacity: 1;
    }

    .admin-task-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg-card);
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .admin-task-btn:hover {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .admin-task-btn.delete:hover {
      background: var(--color-required);
    }

    /* Insert button between tasks */
    .insert-btn {
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .insert-btn button {
      background: var(--bg-card);
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      color: var(--text-muted);
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.4;
    }

    .insert-btn button:hover {
      background: var(--accent);
      color: var(--bg-primary);
      opacity: 1;
      transform: scale(1.2);
    }
    
    .insert-btn.top-insert button {
      opacity: 0.6;
    }

    /* Empty day state */
    .empty-day {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-day button {
      margin-top: 12px;
    }

    /* Modal styles */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 100;
    }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 400px;
    }

    .modal h2 {
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .form-row {
      margin-bottom: 16px;
    }

    .form-row input[type="text"],
    .form-row textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--text-muted);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .form-row input:focus,
    .form-row textarea:focus,
    .form-row select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-row textarea {
      resize: vertical;
      min-height: 60px;
    }

    /* Time stepper */
    .time-stepper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .time-stepper button {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s ease;
    }

    .time-stepper button:hover {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .time-stepper .time-value {
      font-size: 1.1rem;
      font-weight: 600;
      min-width: 80px;
      text-align: center;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
    }

    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .repeat-options {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .mini-btn {
      width: 24px;
      height: 24px;
      border: none;
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .mini-btn:hover {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .interval-value {
      min-width: 20px;
      text-align: center;
      font-weight: 600;
    }

    .weekly-option {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .day-selector {
      display: flex;
      gap: 4px;
      margin-left: 26px;
    }

    .day-btn {
      padding: 6px 10px;
      border: 1px solid var(--text-muted);
      background: var(--bg-primary);
      color: var(--text-muted);
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.2s ease;
    }

    .day-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .day-btn.active {
      background: var(--accent);
      border-color: var(--accent);
      color: var(--bg-primary);
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }
  </style>
</head>
<body x-data="adminApp()">
  <div class="admin-container">
    <header class="admin-header">
      <h1>Ilse.Admin</h1>
      <div class="theme-picker">
        <div 
          class="theme-option" 
          data-theme="dark"
          :class="{ active: theme === 'dark' }"
          @click="setTheme('dark')"
          title="Dark"
        ></div>
        <div 
          class="theme-option" 
          data-theme="solid"
          :class="{ active: theme === 'solid' }"
          @click="setTheme('solid')"
          title="Solid"
        ></div>
        <div 
          class="theme-option" 
          data-theme="sunset"
          :class="{ active: theme === 'sunset' }"
          @click="setTheme('sunset')"
          title="Sunset"
        ></div>
        <div 
          class="theme-option" 
          data-theme="ocean"
          :class="{ active: theme === 'ocean' }"
          @click="setTheme('ocean')"
          title="Ocean"
        ></div>
        <div 
          class="theme-option" 
          data-theme="neon"
          :class="{ active: theme === 'neon' }"
          @click="setTheme('neon')"
          title="Neon"
        ></div>
        <div 
          class="theme-option" 
          data-theme="paper"
          :class="{ active: theme === 'paper' }"
          @click="setTheme('paper')"
          title="Paper"
        ></div>
      </div>
    </header>

    <!-- Day selector dots -->
    <div class="day-slider">
      <template x-for="(day, idx) in days" :key="day.dateStr">
        <div 
          class="day-dot"
          :class="{ active: selectedDayIdx === idx, today: day.isToday }"
          @click="scrollToDay(idx)"
          x-text="day.shortName"
        ></div>
      </template>
    </div>

    <!-- Day panels -->
    <div class="day-panels-wrapper" @wheel.prevent="onWheel($event)">
      <div class="day-panels" id="day-panels" @scroll="onScroll">
        <template x-for="(day, dayIdx) in days" :key="day.dateStr">
          <div class="day-panel" :id="'panel-' + dayIdx">
            <div class="day-panel-header">
              <h2 x-text="day.dayName"></h2>
              <div class="date-str" x-text="day.dateFormatted"></div>
              <div class="total-time" x-text="getDayTotalTime(day.dateStr)"></div>
            </div>
            <div 
              class="day-panel-tasks"
              :data-date="day.dateStr"
              @dragover.prevent="onDragOver($event, day.dateStr)"
              @dragleave="onDragLeave($event)"
              @drop="onDrop($event, day.dateStr)"
            >
              <!-- Insert at top -->
              <div class="insert-btn top-insert">
                <button @click="openCreateModal(day.dateStr, 0)" title="Add task">+</button>
              </div>

              <template x-for="(task, taskIdx) in getTasksForDay(day.dateStr)" :key="task.id">
                <div>
                  <div
                    class="admin-task-card"
                    :class="{
                      'recurring': task.repeat_info && (task.repeat_info.type === 'daily' || task.repeat_info.type === 'weekly'),
                      'one-time': !task.repeat_info || task.repeat_info.type === 'none' || task.repeat_info.type === 'monthly',
                      'dragging': draggedTask?.id === task.id
                    }"
                    :style="`min-height: ${Math.max(40, task.expected_minutes)}px`"
                    draggable="true"
                    :data-task-id="task.id"
                    :data-order="task.order"
                    @dragstart="onDragStart($event, task, day.dateStr)"
                    @dragend="onDragEnd($event)"
                    @dragover.prevent="onTaskDragOver($event, task)"
                    @dragleave="onTaskDragLeave($event)"
                  >
                    <div class="admin-task-content">
                      <span class="admin-task-title" x-text="task.title"></span>
                      <span 
                        class="repeat-badge"
                        x-show="task.repeat_info && (task.repeat_info.type === 'daily' || task.repeat_info.type === 'weekly')"
                        title="Recurring task"
                      >↻</span>
                      <div class="admin-task-actions">
                        <button class="admin-task-btn edit" @click.stop="openEditModal(task)" title="Edit">✎</button>
                        <button class="admin-task-btn delete" @click.stop="deleteTask(task.id)" title="Delete">×</button>
                      </div>
                    </div>
                  </div>
                  <!-- Insert after this task -->
                  <div class="insert-btn">
                    <button @click="openCreateModal(day.dateStr, taskIdx + 1)" title="Insert task">+</button>
                  </div>
                </div>
              </template>

              <!-- Empty state / drop zone -->
              <div 
                class="empty-day" 
                x-show="getTasksForDay(day.dateStr).length === 0"
                @dragover.prevent
              >
                <p x-text="draggedTask ? 'Drop here' : 'No tasks yet'"></p>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-backdrop" x-show="showModal" x-transition @click.self="showModal = false">
    <div class="modal" @click.stop>
      <h2 x-text="editingTask ? 'Edit Task' : 'New Task'"></h2>
      <form @submit.prevent="saveTask()">
        <div class="form-row">
          <input 
            type="text" 
            x-model="form.title" 
            placeholder="Task title" 
            required
            autofocus
          >
        </div>

        <div class="form-row">
          <label class="form-label">Expected time</label>
          <div class="time-stepper">
            <button type="button" @click="form.expected_minutes = Math.max(10, form.expected_minutes - 10)">−</button>
            <span class="time-value" x-text="form.expected_minutes + ' min'"></span>
            <button type="button" @click="form.expected_minutes += 10">+</button>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">Repeat</label>
          <div class="repeat-options">
            <label class="checkbox-row">
              <input type="checkbox" x-model="form.repeat_daily">
              <span>Daily (all work days)</span>
            </label>
            <div class="weekly-option">
              <label class="checkbox-row">
                <input type="checkbox" x-model="form.repeat_weekly">
                <span>Weekly on:</span>
              </label>
              <div class="day-selector" x-show="form.repeat_weekly">
                <template x-for="(day, idx) in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']" :key="day">
                  <button 
                    type="button" 
                    class="day-btn"
                    :class="{ active: form.weekly_days.includes(idx) }"
                    @click="toggleWeeklyDay(idx)"
                    x-text="day"
                  ></button>
                </template>
              </div>
            </div>
            <label class="checkbox-row">
              <input type="checkbox" x-model="form.repeat_monthly">
              <span>Monthly</span>
            </label>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">Description <span class="form-hint">(optional)</span></label>
          <textarea 
            x-model="form.description" 
            placeholder="Additional notes..."
            rows="2"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" @click="showModal = false">Cancel</button>
          <button type="submit" class="btn btn-primary" x-text="editingTask ? 'Save' : 'Create'"></button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function adminApp() {
      return {
        days: [],
        tasks: {},  // keyed by date string
        selectedDayIdx: 0,
        showModal: false,
        editingTask: null,
        insertAtDate: null,
        insertAtOrder: 0,
        theme: localStorage.getItem('admin-theme') || 'solid',
        form: {
          title: '',
          description: '',
          priority: 'optional',
          expected_minutes: 30,
          repeat_daily: false,
          repeat_weekly: false,
          weekly_days: [],  // 0=Mon, 1=Tue, 2=Wed, 3=Thu, 4=Fri
          repeat_monthly: false
        },
        
        setTheme(newTheme) {
          console.log('Setting theme to:', newTheme);
          this.theme = newTheme;
          localStorage.setItem('admin-theme', newTheme);
          document.documentElement.setAttribute('data-theme', newTheme);
          
          // Debug: log computed styles
          const computed = getComputedStyle(document.body);
          console.log('--bg-primary:', computed.getPropertyValue('--bg-primary'));
          console.log('body background:', computed.backgroundColor);
        },

        // Drag and drop state
        draggedTask: null,
        draggedFromDate: null,
        dropTargetTask: null,

        async init() {
          this.buildDays();
          await this.loadAllTasks();
          // Scroll to today
          this.$nextTick(() => this.scrollToDay(this.selectedDayIdx));
        },

        buildDays() {
          const days = [];
          const today = new Date();
          const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
          
          // Find Monday of current week
          const dayOfWeek = today.getDay(); // 0=Sun, 1=Mon, etc.
          const monday = new Date(today);
          monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
          
          for (let i = 0; i < 7; i++) {
            const d = new Date(monday);
            d.setDate(monday.getDate() + i);
            const isToday = d.toDateString() === today.toDateString();
            days.push({
              date: d,
              dateStr: d.toISOString().split('T')[0],
              shortName: dayNames[i],
              dayName: dayNames[i],
              dateFormatted: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),
              isToday: isToday
            });
          }
          this.days = days;
          
          // Set initial selection to today
          this.selectedDayIdx = days.findIndex(d => d.isToday);
          if (this.selectedDayIdx < 0) this.selectedDayIdx = 0;
        },

        async loadAllTasks() {
          for (const day of this.days) {
            try {
              // This endpoint auto-generates tasks from templates
              const response = await fetch(`/api/tasks/date/${day.dateStr}`);
              let tasks = await response.json();
              tasks.sort((a, b) => a.order - b.order);
              this.tasks[day.dateStr] = tasks;
            } catch (err) {
              console.error('Failed to load tasks for', day.dateStr, err);
              this.tasks[day.dateStr] = [];
            }
          }
        },

        getTasksForDay(dateStr) {
          return this.tasks[dateStr] || [];
        },

        getDayTotalTime(dateStr) {
          const tasks = this.getTasksForDay(dateStr);
          const total = tasks.reduce((sum, t) => sum + (t.expected_minutes || 0), 0);
          if (total === 0) return '';
          const hrs = Math.floor(total / 60);
          const mins = total % 60;
          return hrs > 0 ? `${hrs}h ${mins}m total` : `${mins}m total`;
        },

        scrollToDay(idx) {
          this.selectedDayIdx = idx;
          const panel = document.getElementById('panel-' + idx);
          if (panel) {
            panel.scrollIntoView({ behavior: 'smooth', inline: 'center' });
          }
        },

        onScroll() {
          // Update selected day based on scroll position
          const container = document.getElementById('day-panels');
          const panels = container.querySelectorAll('.day-panel');
          const containerCenter = container.scrollLeft + container.clientWidth / 2;
          
          let closestIdx = 0;
          let closestDist = Infinity;
          
          panels.forEach((panel, idx) => {
            const panelCenter = panel.offsetLeft + panel.clientWidth / 2;
            const dist = Math.abs(panelCenter - containerCenter);
            if (dist < closestDist) {
              closestDist = dist;
              closestIdx = idx;
            }
          });
          
          this.selectedDayIdx = closestIdx;
        },
        
        onWheel(e) {
          // Convert vertical scroll to horizontal
          const container = document.getElementById('day-panels');
          container.scrollLeft += e.deltaY * 2;
        },

        openCreateModal(dateStr, order) {
          this.editingTask = null;
          this.insertAtDate = dateStr;
          this.insertAtOrder = order;
          // Get day of week for this date (0=Mon for our array)
          const d = new Date(dateStr);
          const dayIdx = (d.getDay() + 6) % 7; // Convert Sun=0 to Mon=0
          this.form = {
            title: '',
            description: '',
            priority: 'optional',
            expected_minutes: 30,
            repeat_daily: false,
            repeat_weekly: false,
            weekly_days: dayIdx < 5 ? [dayIdx] : [], // Default to current day if weekday
            repeat_monthly: false
          };
          this.showModal = true;
        },
        
        toggleWeeklyDay(idx) {
          const i = this.form.weekly_days.indexOf(idx);
          if (i >= 0) {
            this.form.weekly_days.splice(i, 1);
          } else {
            this.form.weekly_days.push(idx);
            this.form.weekly_days.sort();
          }
        },

        openEditModal(task) {
          this.editingTask = task;
          
          // Pre-populate repeat settings from task's repeat_info
          let repeatDaily = false;
          let repeatWeekly = false;
          let repeatMonthly = false;
          let weeklyDays = [];
          
          if (task.repeat_info) {
            if (task.repeat_info.type === 'daily') {
              repeatDaily = true;
            } else if (task.repeat_info.type === 'weekly') {
              repeatWeekly = true;
              // Convert day names to indices
              const dayMap = { 'Mon': 0, 'Tue': 1, 'Wed': 2, 'Thu': 3, 'Fri': 4 };
              weeklyDays = (task.repeat_info.days || [])
                .map(d => dayMap[d])
                .filter(d => d !== undefined);
            } else if (task.repeat_info.type === 'monthly') {
              repeatMonthly = true;
            }
          }
          
          this.form = {
            title: task.title,
            description: task.description || '',
            priority: task.priority,
            expected_minutes: task.expected_minutes || 30,
            repeat_daily: repeatDaily,
            repeat_weekly: repeatWeekly,
            weekly_days: weeklyDays,
            repeat_monthly: repeatMonthly
          };
          this.showModal = true;
        },

        async saveTask() {
          if (this.editingTask) {
            // Update existing task
            try {
              await fetch(`/api/tasks/${this.editingTask.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  title: this.form.title,
                  description: this.form.description || null,
                  priority: this.form.priority,
                  expected_minutes: this.form.expected_minutes
                })
              });
            } catch (err) {
              console.error('Failed to update task:', err);
            }
          } else {
            // Determine repeat type
            let repeatType = 'none';
            let weekdays = '';
            
            if (this.form.repeat_daily) {
              repeatType = 'daily';
            } else if (this.form.repeat_weekly && this.form.weekly_days.length > 0) {
              repeatType = 'weekly';
              weekdays = this.form.weekly_days.join(',');
            } else if (this.form.repeat_monthly) {
              repeatType = 'monthly';
            }
            
            // If repeating, create a template
            if (repeatType !== 'none') {
              try {
                await fetch('/api/admin/templates', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    title: this.form.title,
                    description: this.form.description || null,
                    priority: this.form.priority,
                    expected_minutes: this.form.expected_minutes,
                    order: this.insertAtOrder,
                    repeat_type: repeatType,
                    weekdays: weekdays
                  })
                });
                // Tasks will be auto-generated when viewing dates
              } catch (err) {
                console.error('Failed to create template:', err);
              }
            } else {
              // Non-repeating: create single task
              const dayTasks = this.getTasksForDay(this.insertAtDate);
              for (const t of dayTasks) {
                if (t.order >= this.insertAtOrder) {
                  t.order += 1;
                }
              }
              if (dayTasks.length > 0) {
                await fetch('/api/admin/tasks/reorder', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(dayTasks.map(t => ({ id: t.id, order: t.order })))
                });
              }
              
              try {
                await fetch('/api/admin/tasks', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    title: this.form.title,
                    description: this.form.description || null,
                    priority: this.form.priority,
                    expected_minutes: this.form.expected_minutes,
                    order: this.insertAtOrder,
                    scheduled_date: this.insertAtDate
                  })
                });
              } catch (err) {
                console.error('Failed to create task:', err);
              }
            }
          }

          this.showModal = false;
          await this.loadAllTasks();
        },

        async deleteTask(taskId) {
          try {
            await fetch(`/api/admin/tasks/${taskId}`, { method: 'DELETE' });
            await this.loadAllTasks();
          } catch (err) {
            console.error('Failed to delete task:', err);
          }
        },

        // Drag and drop handlers
        onDragStart(e, task, dateStr) {
          this.draggedTask = task;
          this.draggedFromDate = dateStr;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', task.id);
          // Add dragging class after a tick to not affect the drag image
          setTimeout(() => {
            e.target.classList.add('dragging');
          }, 0);
        },
        
        onDragEnd(e) {
          e.target.classList.remove('dragging');
          this.draggedTask = null;
          this.draggedFromDate = null;
          this.dropTargetTask = null;
          // Remove all drag-over classes
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        },
        
        onTaskDragOver(e, task) {
          if (!this.draggedTask || this.draggedTask.id === task.id) return;
          e.target.closest('.admin-task-card')?.classList.add('drag-over');
          this.dropTargetTask = task;
        },
        
        onTaskDragLeave(e) {
          e.target.closest('.admin-task-card')?.classList.remove('drag-over');
        },
        
        onDragOver(e, dateStr) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        },
        
        onDragLeave(e) {
          // Only remove if leaving the panel entirely
          if (!e.relatedTarget?.closest('.day-panel-tasks')) {
            e.currentTarget.closest('.day-panel')?.classList.remove('drag-over');
          }
        },
        
        async onDrop(e, targetDate) {
          e.preventDefault();
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
          
          if (!this.draggedTask) return;
          
          const task = this.draggedTask;
          const fromDate = this.draggedFromDate;
          const fromTasks = this.tasks[fromDate] || [];
          const targetTasks = this.tasks[targetDate] || [];
          
          // Determine new order
          let newOrder = 0;
          if (this.dropTargetTask && targetDate === this.dropTargetTask.scheduled_date?.split('T')[0]) {
            newOrder = this.dropTargetTask.order;
          } else if (targetTasks.length > 0) {
            newOrder = Math.max(...targetTasks.map(t => t.order)) + 1;
          }
          
          // Clear drag state first
          this.draggedTask = null;
          this.draggedFromDate = null;
          const dropTarget = this.dropTargetTask;
          this.dropTargetTask = null;
          
          // OPTIMISTIC UI UPDATE - happens immediately
          if (fromDate === targetDate && dropTarget) {
            // Same day reorder
            const fromIdx = fromTasks.findIndex(t => t.id === task.id);
            const toIdx = fromTasks.findIndex(t => t.id === dropTarget.id);
            
            if (fromIdx !== -1 && toIdx !== -1 && fromIdx !== toIdx) {
              // Remove from old position
              fromTasks.splice(fromIdx, 1);
              // Insert at new position
              const insertIdx = fromIdx < toIdx ? toIdx - 1 : toIdx;
              fromTasks.splice(insertIdx, 0, task);
              
              // Update orders in local state
              fromTasks.forEach((t, i) => t.order = i);
              
              // Trigger reactivity
              this.tasks[fromDate] = [...fromTasks];
              
              // Sync with backend in background (no await)
              const reorders = fromTasks.map((t, i) => ({ id: t.id, order: i }));
              fetch('/api/admin/tasks/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reorders)
              }).catch(err => console.error('Reorder failed:', err));
            }
          } else if (fromDate !== targetDate) {
            // Move to different day - update UI immediately
            // Remove from source
            const fromIdx = fromTasks.findIndex(t => t.id === task.id);
            if (fromIdx !== -1) {
              fromTasks.splice(fromIdx, 1);
              fromTasks.forEach((t, i) => t.order = i);
              this.tasks[fromDate] = [...fromTasks];
            }
            
            // Shift orders in target and insert
            targetTasks.forEach(t => {
              if (t.order >= newOrder) t.order += 1;
            });
            task.order = newOrder;
            task.scheduled_date = targetDate;
            targetTasks.push(task);
            targetTasks.sort((a, b) => a.order - b.order);
            this.tasks[targetDate] = [...targetTasks];
            
            // Sync with backend in background
            if (targetTasks.length > 1) {
              fetch('/api/admin/tasks/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(targetTasks.map(t => ({ id: t.id, order: t.order })))
              }).catch(err => console.error('Reorder failed:', err));
            }
            
            fetch(`/api/admin/tasks/${task.id}/move?target_date=${targetDate}&order=${newOrder}`, {
              method: 'POST'
            }).then(response => {
              if (!response.ok) {
                console.error('Move failed with status:', response.status);
                // Reload to get correct state
                this.loadAllTasks();
              }
            }).catch(err => {
              console.error('Move failed:', err);
              this.loadAllTasks();
            });
          }
        }
      };
    }
  </script>
</body>
</html>
