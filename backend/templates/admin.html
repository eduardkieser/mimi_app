<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ilsa.Admin - Mimi.Today</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
  <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
  <style>
    /* Admin-specific styles */
    .admin-container {
      max-width: 100%;
      padding: 16px;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .admin-header {
      text-align: center;
      padding: 8px 0 16px;
      flex-shrink: 0;
    }

    .admin-header h1 {
      font-size: 1.8rem;
      background: linear-gradient(135deg, var(--accent), #bb9af7);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Day slider */
    .day-slider {
      display: flex;
      gap: 8px;
      padding: 8px 0 16px;
      justify-content: center;
      flex-wrap: wrap;
      flex-shrink: 0;
    }

    .day-dot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid transparent;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-muted);
    }

    .day-dot:hover {
      border-color: var(--accent);
      color: var(--text-primary);
    }

    .day-dot.active {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }

    .day-dot.today {
      border-color: var(--color-completed);
    }

    /* Day panels container */
    .day-panels-wrapper {
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    .day-panels {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      padding: 0 calc(50% - 180px);
      height: 100%;
      -webkit-overflow-scrolling: touch;
    }

    .day-panels::-webkit-scrollbar {
      display: none;
    }

    /* Day panel */
    .day-panel {
      flex: 0 0 360px;
      scroll-snap-align: center;
      background: var(--bg-card);
      border-radius: var(--radius);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 180px);
    }

    .day-panel-header {
      padding: 16px;
      border-bottom: 1px solid var(--bg-primary);
      text-align: center;
      flex-shrink: 0;
    }

    .day-panel-header h2 {
      font-size: 1.1rem;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .day-panel-header .date-str {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .day-panel-header .total-time {
      font-size: 0.8rem;
      color: var(--accent);
      margin-top: 4px;
    }

    .day-panel-tasks {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    /* Task card in admin */
    .admin-task-card {
      background: var(--bg-primary);
      border-radius: var(--radius-sm);
      margin-bottom: 4px;
      position: relative;
      border-left: 3px solid var(--text-muted);
      transition: all 0.2s ease;
    }

    .admin-task-card.required {
      border-left-color: var(--color-required);
    }

    .admin-task-card.optional {
      border-left-color: var(--color-optional);
    }

    .admin-task-card:hover {
      background: var(--bg-hover);
    }

    .admin-task-card[draggable="true"] {
      cursor: grab;
    }

    .admin-task-card.dragging {
      opacity: 0.5;
      cursor: grabbing;
    }

    .admin-task-card.drag-over {
      border-top: 2px solid var(--accent);
      margin-top: -2px;
    }

    .day-panel.drag-over {
      background: var(--bg-hover);
    }

    .admin-task-content {
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .admin-task-title {
      flex: 1;
      font-weight: 500;
    }

    .admin-task-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .admin-task-card:hover .admin-task-actions {
      opacity: 1;
    }

    .admin-task-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: var(--bg-card);
      color: var(--text-muted);
      border-radius: 6px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .admin-task-btn:hover {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .admin-task-btn.delete:hover {
      background: var(--color-required);
    }

    /* Insert button between tasks */
    .insert-btn {
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      transition: opacity 0.2s ease;
    }

    .day-panel-tasks:hover .insert-btn {
      opacity: 1;
    }

    .insert-btn button {
      background: transparent;
      border: 1px dashed var(--text-muted);
      border-radius: 12px;
      color: var(--text-muted);
      font-size: 0.7rem;
      padding: 2px 12px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .insert-btn button:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(122, 162, 247, 0.1);
    }

    /* Empty day state */
    .empty-day {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .empty-day button {
      margin-top: 12px;
    }

    /* Modal styles */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      z-index: 100;
    }

    .modal {
      background: var(--bg-card);
      border-radius: var(--radius);
      padding: 24px;
      width: 100%;
      max-width: 400px;
    }

    .modal h2 {
      margin-bottom: 20px;
      font-size: 1.2rem;
    }

    .form-row {
      margin-bottom: 16px;
    }

    .form-row input[type="text"],
    .form-row textarea {
      width: 100%;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--text-muted);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 1rem;
    }

    .form-row input:focus,
    .form-row textarea:focus,
    .form-row select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .form-row textarea {
      resize: vertical;
      min-height: 60px;
    }

    /* Priority dropdown with colors */
    .priority-select {
      width: 100%;
      padding: 12px;
      background: var(--bg-primary);
      border: 1px solid var(--text-muted);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 1rem;
      cursor: pointer;
    }

    .priority-select.optional {
      border-color: var(--color-optional);
      color: var(--color-optional);
    }

    .priority-select.required {
      border-color: var(--color-required);
      color: var(--color-required);
    }

    /* Time stepper */
    .time-stepper {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .time-stepper button {
      width: 36px;
      height: 36px;
      border: none;
      background: var(--bg-primary);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: 1.2rem;
      transition: all 0.2s ease;
    }

    .time-stepper button:hover {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .time-stepper .time-value {
      font-size: 1.1rem;
      font-weight: 600;
      min-width: 80px;
      text-align: center;
    }

    .form-label {
      display: block;
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .form-hint {
      font-size: 0.75rem;
      color: var(--text-muted);
      font-style: italic;
    }

    .checkbox-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 0;
    }

    .checkbox-row input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .modal-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .btn {
      padding: 10px 20px;
      border-radius: var(--radius-sm);
      border: none;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg-primary);
    }

    .btn-primary:hover {
      background: var(--accent-hover);
    }

    .btn-secondary {
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-hover);
    }
  </style>
</head>
<body x-data="adminApp()">
  <div class="admin-container">
    <header class="admin-header">
      <h1>Ilsa.Admin</h1>
    </header>

    <!-- Day selector dots -->
    <div class="day-slider">
      <template x-for="(day, idx) in days" :key="day.dateStr">
        <div 
          class="day-dot"
          :class="{ active: selectedDayIdx === idx, today: idx === 0 }"
          @click="scrollToDay(idx)"
          x-text="day.shortName"
        ></div>
      </template>
    </div>

    <!-- Day panels -->
    <div class="day-panels-wrapper">
      <div class="day-panels" id="day-panels" @scroll="onScroll">
        <template x-for="(day, dayIdx) in days" :key="day.dateStr">
          <div class="day-panel" :id="'panel-' + dayIdx">
            <div class="day-panel-header">
              <h2 x-text="day.dayName"></h2>
              <div class="date-str" x-text="day.dateFormatted"></div>
              <div class="total-time" x-text="getDayTotalTime(day.dateStr)"></div>
            </div>
            <div 
              class="day-panel-tasks"
              :data-date="day.dateStr"
              @dragover.prevent="onDragOver($event, day.dateStr)"
              @dragleave="onDragLeave($event)"
              @drop="onDrop($event, day.dateStr)"
            >
              <!-- Insert at top -->
              <div class="insert-btn">
                <button @click="openCreateModal(day.dateStr, 0)">
                  <span>+</span> Add task
                </button>
              </div>

              <template x-for="(task, taskIdx) in getTasksForDay(day.dateStr)" :key="task.id">
                <div
                  class="admin-task-card"
                  :class="[task.priority, { 'dragging': draggedTask?.id === task.id }]"
                  :style="`min-height: ${Math.max(40, task.expected_minutes)}px`"
                  draggable="true"
                  :data-task-id="task.id"
                  :data-order="task.order"
                  @dragstart="onDragStart($event, task, day.dateStr)"
                  @dragend="onDragEnd($event)"
                  @dragover.prevent="onTaskDragOver($event, task)"
                  @dragleave="onTaskDragLeave($event)"
                >
                  <div class="admin-task-content">
                    <span class="admin-task-title" x-text="task.title"></span>
                    <div class="admin-task-actions">
                      <button class="admin-task-btn edit" @click.stop="openEditModal(task)" title="Edit">âœŽ</button>
                      <button class="admin-task-btn delete" @click.stop="deleteTask(task.id)" title="Delete">Ã—</button>
                    </div>
                  </div>
                </div>
              </template>

              <!-- Empty state / drop zone -->
              <div 
                class="empty-day" 
                x-show="getTasksForDay(day.dateStr).length === 0"
                @dragover.prevent
              >
                <p x-text="draggedTask ? 'Drop here' : 'No tasks scheduled'"></p>
                <button class="btn btn-primary" @click="openCreateModal(day.dateStr, 0)" x-show="!draggedTask">Add first task</button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-backdrop" x-show="showModal" x-transition @click.self="showModal = false">
    <div class="modal" @click.stop>
      <h2 x-text="editingTask ? 'Edit Task' : 'New Task'"></h2>
      <form @submit.prevent="saveTask()">
        <div class="form-row">
          <input 
            type="text" 
            x-model="form.title" 
            placeholder="Task title" 
            required
            autofocus
          >
        </div>

        <div class="form-row">
          <select 
            class="priority-select"
            :class="form.priority"
            x-model="form.priority"
          >
            <option value="optional">ðŸŸ¡ Optional</option>
            <option value="required">ðŸ”´ Required</option>
          </select>
        </div>

        <div class="form-row">
          <label class="form-label">Expected time</label>
          <div class="time-stepper">
            <button type="button" @click="form.expected_minutes = Math.max(10, form.expected_minutes - 10)">âˆ’</button>
            <span class="time-value" x-text="form.expected_minutes + ' min'"></span>
            <button type="button" @click="form.expected_minutes += 10">+</button>
          </div>
        </div>

        <div class="form-row">
          <label class="checkbox-row">
            <input type="checkbox" x-model="form.is_recurring">
            <span>Repeat every week</span>
          </label>
        </div>

        <div class="form-row">
          <label class="form-label">Description <span class="form-hint">(optional)</span></label>
          <textarea 
            x-model="form.description" 
            placeholder="Additional notes..."
            rows="2"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" @click="showModal = false">Cancel</button>
          <button type="submit" class="btn btn-primary" x-text="editingTask ? 'Save' : 'Create'"></button>
        </div>
      </form>
    </div>
  </div>

  <script>
    function adminApp() {
      return {
        days: [],
        tasks: {},  // keyed by date string
        selectedDayIdx: 0,
        showModal: false,
        editingTask: null,
        insertAtDate: null,
        insertAtOrder: 0,
        form: {
          title: '',
          description: '',
          priority: 'optional',
          expected_minutes: 30,
          is_recurring: true
        },
        
        // Drag and drop state
        draggedTask: null,
        draggedFromDate: null,
        dropTargetTask: null,

        async init() {
          this.buildDays();
          await this.loadAllTasks();
          // Start scrolled to today
          this.$nextTick(() => this.scrollToDay(0));
        },

        buildDays() {
          const days = [];
          const today = new Date();
          const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
          const fullDayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
          
          for (let i = 0; i < 7; i++) {
            const d = new Date(today);
            d.setDate(today.getDate() + i);
            days.push({
              date: d,
              dateStr: d.toISOString().split('T')[0],
              shortName: dayNames[d.getDay()],
              dayName: i === 0 ? 'Today' : (i === 1 ? 'Tomorrow' : fullDayNames[d.getDay()]),
              dateFormatted: d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })
            });
          }
          this.days = days;
        },

        async loadAllTasks() {
          for (const day of this.days) {
            try {
              const response = await fetch(`/api/tasks/date/${day.dateStr}`);
              const tasks = await response.json();
              tasks.sort((a, b) => a.order - b.order);
              this.tasks[day.dateStr] = tasks;
            } catch (err) {
              console.error('Failed to load tasks for', day.dateStr, err);
              this.tasks[day.dateStr] = [];
            }
          }
        },

        getTasksForDay(dateStr) {
          return this.tasks[dateStr] || [];
        },

        getDayTotalTime(dateStr) {
          const tasks = this.getTasksForDay(dateStr);
          const total = tasks.reduce((sum, t) => sum + (t.expected_minutes || 0), 0);
          if (total === 0) return '';
          const hrs = Math.floor(total / 60);
          const mins = total % 60;
          return hrs > 0 ? `${hrs}h ${mins}m total` : `${mins}m total`;
        },

        scrollToDay(idx) {
          this.selectedDayIdx = idx;
          const panel = document.getElementById('panel-' + idx);
          if (panel) {
            panel.scrollIntoView({ behavior: 'smooth', inline: 'center' });
          }
        },

        onScroll() {
          // Update selected day based on scroll position
          const container = document.getElementById('day-panels');
          const panels = container.querySelectorAll('.day-panel');
          const containerCenter = container.scrollLeft + container.clientWidth / 2;
          
          let closestIdx = 0;
          let closestDist = Infinity;
          
          panels.forEach((panel, idx) => {
            const panelCenter = panel.offsetLeft + panel.clientWidth / 2;
            const dist = Math.abs(panelCenter - containerCenter);
            if (dist < closestDist) {
              closestDist = dist;
              closestIdx = idx;
            }
          });
          
          this.selectedDayIdx = closestIdx;
        },

        openCreateModal(dateStr, order) {
          this.editingTask = null;
          this.insertAtDate = dateStr;
          this.insertAtOrder = order;
          this.form = {
            title: '',
            description: '',
            priority: 'optional',
            expected_minutes: 30,
            is_recurring: true
          };
          this.showModal = true;
        },

        openEditModal(task) {
          this.editingTask = task;
          this.form = {
            title: task.title,
            description: task.description || '',
            priority: task.priority,
            expected_minutes: task.expected_minutes || 30,
            is_recurring: false  // Can't change recurring for existing tasks
          };
          this.showModal = true;
        },

        async saveTask() {
          if (this.editingTask) {
            // Update existing task
            try {
              await fetch(`/api/tasks/${this.editingTask.id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  title: this.form.title,
                  description: this.form.description || null,
                  priority: this.form.priority,
                  expected_minutes: this.form.expected_minutes
                })
              });
            } catch (err) {
              console.error('Failed to update task:', err);
            }
          } else {
            // Create new task
            // First, shift orders of tasks at or after insert position
            const dayTasks = this.getTasksForDay(this.insertAtDate);
            for (const t of dayTasks) {
              if (t.order >= this.insertAtOrder) {
                t.order += 1;
              }
            }
            // Save the new orders
            if (dayTasks.length > 0) {
              await fetch('/api/admin/tasks/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(dayTasks.map(t => ({ id: t.id, order: t.order })))
              });
            }
            
            // Create the task
            try {
              await fetch('/api/admin/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  title: this.form.title,
                  description: this.form.description || null,
                  priority: this.form.priority,
                  expected_minutes: this.form.expected_minutes,
                  order: this.insertAtOrder,
                  scheduled_date: this.insertAtDate
                })
              });

              // TODO: If is_recurring, also create a template
            } catch (err) {
              console.error('Failed to create task:', err);
            }
          }

          this.showModal = false;
          await this.loadAllTasks();
        },

        async deleteTask(taskId) {
          if (!confirm('Delete this task?')) return;
          try {
            await fetch(`/api/admin/tasks/${taskId}`, { method: 'DELETE' });
            await this.loadAllTasks();
          } catch (err) {
            console.error('Failed to delete task:', err);
          }
        },

        // Drag and drop handlers
        onDragStart(e, task, dateStr) {
          this.draggedTask = task;
          this.draggedFromDate = dateStr;
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', task.id);
          // Add dragging class after a tick to not affect the drag image
          setTimeout(() => {
            e.target.classList.add('dragging');
          }, 0);
        },
        
        onDragEnd(e) {
          e.target.classList.remove('dragging');
          this.draggedTask = null;
          this.draggedFromDate = null;
          this.dropTargetTask = null;
          // Remove all drag-over classes
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        },
        
        onTaskDragOver(e, task) {
          if (!this.draggedTask || this.draggedTask.id === task.id) return;
          e.target.closest('.admin-task-card')?.classList.add('drag-over');
          this.dropTargetTask = task;
        },
        
        onTaskDragLeave(e) {
          e.target.closest('.admin-task-card')?.classList.remove('drag-over');
        },
        
        onDragOver(e, dateStr) {
          e.preventDefault();
          e.dataTransfer.dropEffect = 'move';
        },
        
        onDragLeave(e) {
          // Only remove if leaving the panel entirely
          if (!e.relatedTarget?.closest('.day-panel-tasks')) {
            e.currentTarget.closest('.day-panel')?.classList.remove('drag-over');
          }
        },
        
        async onDrop(e, targetDate) {
          e.preventDefault();
          document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
          
          if (!this.draggedTask) return;
          
          const task = this.draggedTask;
          const fromDate = this.draggedFromDate;
          const targetTasks = this.getTasksForDay(targetDate);
          
          // Determine new order
          let newOrder = 0;
          if (this.dropTargetTask && targetDate === this.dropTargetTask.scheduled_date?.split('T')[0]) {
            // Dropped on another task - insert before it
            newOrder = this.dropTargetTask.order;
          } else if (targetTasks.length > 0) {
            // Dropped in empty area - add to end
            newOrder = Math.max(...targetTasks.map(t => t.order)) + 1;
          }
          
          // If same day and we have a target, reorder locally
          if (fromDate === targetDate && this.dropTargetTask) {
            // Reorder within same day
            const tasks = [...targetTasks];
            const fromIdx = tasks.findIndex(t => t.id === task.id);
            const toIdx = tasks.findIndex(t => t.id === this.dropTargetTask.id);
            
            if (fromIdx !== -1 && toIdx !== -1 && fromIdx !== toIdx) {
              // Remove from old position
              tasks.splice(fromIdx, 1);
              // Insert at new position
              const insertIdx = fromIdx < toIdx ? toIdx - 1 : toIdx;
              tasks.splice(insertIdx, 0, task);
              
              // Update all orders
              const reorders = tasks.map((t, i) => ({ id: t.id, order: i }));
              await fetch('/api/admin/tasks/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(reorders)
              });
            }
          } else if (fromDate !== targetDate) {
            // Moving to different day
            // Shift orders in target day
            for (const t of targetTasks) {
              if (t.order >= newOrder) {
                t.order += 1;
              }
            }
            if (targetTasks.length > 0) {
              await fetch('/api/admin/tasks/reorder', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(targetTasks.map(t => ({ id: t.id, order: t.order })))
              });
            }
            
            // Move the task
            await fetch(`/api/admin/tasks/${task.id}/move?target_date=${targetDate}&order=${newOrder}`, {
              method: 'POST'
            });
          }
          
          this.draggedTask = null;
          this.draggedFromDate = null;
          this.dropTargetTask = null;
          await this.loadAllTasks();
        }
      };
    }
  </script>
</body>
</html>
