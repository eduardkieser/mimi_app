<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ilse.Admin - Mimi.Today</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css">
  <link rel="stylesheet" href="/static/admin.css">
  <script defer src="https://unpkg.com/alpinejs@3.13.3/dist/cdn.min.js"></script>
  <script src="/static/admin.js"></script>
  <script>
    // Set theme before page renders to prevent flash
    document.documentElement.setAttribute('data-theme', localStorage.getItem('admin-theme') || 'solid');
  </script>
</head>
<body x-data="adminApp()">
  <div class="admin-container">
    <header class="admin-header">
      <h1>Ilse.Admin</h1>
      <div class="theme-picker">
        <div class="theme-option" data-theme="dark" :class="{ active: theme === 'dark' }" @click="setTheme('dark')" title="Dark"></div>
        <div class="theme-option" data-theme="solid" :class="{ active: theme === 'solid' }" @click="setTheme('solid')" title="Solid"></div>
        <div class="theme-option" data-theme="sunset" :class="{ active: theme === 'sunset' }" @click="setTheme('sunset')" title="Sunset"></div>
        <div class="theme-option" data-theme="ocean" :class="{ active: theme === 'ocean' }" @click="setTheme('ocean')" title="Ocean"></div>
        <div class="theme-option" data-theme="neon" :class="{ active: theme === 'neon' }" @click="setTheme('neon')" title="Neon"></div>
        <div class="theme-option" data-theme="paper" :class="{ active: theme === 'paper' }" @click="setTheme('paper')" title="Paper"></div>
      </div>
    </header>

    <!-- Day selector dots -->
    <div class="day-slider">
      <template x-for="(day, idx) in days" :key="day.dateStr">
        <div 
          class="day-dot"
          :class="{ active: selectedDayIdx === idx, today: day.isToday }"
          @click="scrollToDay(idx)"
          x-text="day.shortName"
        ></div>
      </template>
    </div>

    <!-- Day panels -->
    <div class="day-panels-wrapper" @wheel.prevent="onWheel($event)">
      <div class="day-panels" id="day-panels" @scroll="onScroll">
        <template x-for="(day, dayIdx) in days" :key="day.dateStr">
          <div class="day-panel" :id="'panel-' + dayIdx">
            <div class="day-panel-header">
              <h2 x-text="day.dayName"></h2>
              <div class="date-str" x-text="day.dateFormatted"></div>
              <div class="total-time" x-text="getDayTotalTime(day.dateStr)"></div>
            </div>
            <div 
              class="day-panel-tasks"
              :data-date="day.dateStr"
              @dragover.prevent="onDragOver($event, day.dateStr)"
              @dragleave="onDragLeave($event)"
              @drop="onDrop($event, day.dateStr)"
            >
              <!-- Insert at top -->
              <div class="insert-btn top-insert">
                <button @click="openCreateModal(day.dateStr, 0)" title="Add task">+</button>
              </div>

              <template x-for="(task, taskIdx) in getTasksForDay(day.dateStr)" :key="task.id">
                <div>
                  <div
                    class="admin-task-card"
                    :class="{
                      'recurring': task.repeat_info && (task.repeat_info.type === 'daily' || task.repeat_info.type === 'weekly'),
                      'one-time': !task.repeat_info || task.repeat_info.type === 'none' || task.repeat_info.type === 'monthly',
                      'dragging': draggedTask?.id === task.id
                    }"
                    :style="`min-height: ${Math.max(40, task.expected_minutes)}px`"
                    draggable="true"
                    :data-task-id="task.id"
                    :data-order="task.order"
                    @dragstart="onDragStart($event, task, day.dateStr)"
                    @dragend="onDragEnd($event)"
                    @dragover.prevent="onTaskDragOver($event, task)"
                    @dragleave="onTaskDragLeave($event)"
                  >
                    <div class="admin-task-content">
                      <span class="admin-task-title" x-text="task.title"></span>
                      <span 
                        class="repeat-badge"
                        x-show="task.repeat_info && (task.repeat_info.type === 'daily' || task.repeat_info.type === 'weekly')"
                        title="Recurring task"
                      >↻</span>
                      <div class="admin-task-actions">
                        <button class="admin-task-btn edit" @click.stop="openEditModal(task)" title="Edit">✎</button>
                        <button class="admin-task-btn delete" @click.stop="deleteTask(task.id)" title="Delete">×</button>
                      </div>
                    </div>
                  </div>
                  <!-- Insert after this task -->
                  <div class="insert-btn">
                    <button @click="openCreateModal(day.dateStr, taskIdx + 1)" title="Insert task">+</button>
                  </div>
                </div>
              </template>

              <!-- Empty state / drop zone -->
              <div 
                class="empty-day" 
                x-show="getTasksForDay(day.dateStr).length === 0"
                @dragover.prevent
              >
                <p x-text="draggedTask ? 'Drop here' : 'No tasks yet'"></p>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <div class="modal-backdrop" x-show="showModal" x-transition @click.self="showModal = false">
    <div class="modal" @click.stop>
      <h2 x-text="editingTask ? 'Edit Task' : 'New Task'"></h2>
      <form @submit.prevent="saveTask()">
        <div class="form-row">
          <input 
            type="text" 
            x-model="form.title" 
            placeholder="Task title" 
            required
            autofocus
          >
        </div>

        <div class="form-row">
          <label class="form-label">Expected time</label>
          <div class="time-stepper">
            <button type="button" @click="form.expected_minutes = Math.max(10, form.expected_minutes - 10)">−</button>
            <span class="time-value" x-text="form.expected_minutes + ' min'"></span>
            <button type="button" @click="form.expected_minutes += 10">+</button>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">Repeat</label>
          <div class="repeat-options">
            <label class="checkbox-row">
              <input type="checkbox" x-model="form.repeat_daily">
              <span>Daily (all work days)</span>
            </label>
            <div class="weekly-option">
              <label class="checkbox-row">
                <input type="checkbox" x-model="form.repeat_weekly">
                <span>Weekly on:</span>
              </label>
              <div class="day-selector" x-show="form.repeat_weekly">
                <template x-for="(day, idx) in ['Mon', 'Tue', 'Wed', 'Thu', 'Fri']" :key="day">
                  <button 
                    type="button" 
                    class="day-btn"
                    :class="{ active: form.weekly_days.includes(idx) }"
                    @click="toggleWeeklyDay(idx)"
                    x-text="day"
                  ></button>
                </template>
              </div>
            </div>
            <label class="checkbox-row">
              <input type="checkbox" x-model="form.repeat_monthly">
              <span>Monthly</span>
            </label>
          </div>
        </div>

        <div class="form-row">
          <label class="form-label">Description <span class="form-hint">(optional)</span></label>
          <textarea 
            x-model="form.description" 
            placeholder="Additional notes..."
            rows="2"
          ></textarea>
        </div>

        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" @click="showModal = false">Cancel</button>
          <button type="submit" class="btn btn-primary" x-text="editingTask ? 'Save' : 'Create'"></button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
